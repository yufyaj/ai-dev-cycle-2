name: TDDé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  id-token: write

jobs:
  tdd-implement:
    # tdd-implement:frontend ã¾ãŸã¯ tdd-implement:backend ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ
    if: |
      github.event.label.name == 'tdd-implement:frontend' ||
      github.event.label.name == 'tdd-implement:backend'
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’æŠ½å‡º
        id: extract-package
        run: |
          LABEL_NAME="${{ github.event.label.name }}"
          PACKAGE=$(echo $LABEL_NAME | cut -d':' -f2)
          echo "package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: ${PACKAGE}"

      - name: TDDé§†å‹•é–‹ç™ºã®å®Ÿè¡Œ
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: Write,Edit,Bash
          prompt: |
            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ github.event.issue.number }} ã®å†…å®¹ã‚’ç¢ºèªã—ã€TDDï¼ˆTest-Driven Developmentï¼‰ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ## ğŸ¯ å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            **${{ steps.extract-package.outputs.package }}** ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

            **é‡è¦**: ã™ã¹ã¦ã®ä½œæ¥­ã¯ `packages/${{ steps.extract-package.outputs.package }}/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§è¡Œã£ã¦ãã ã•ã„ã€‚

            ## TDDã‚µã‚¤ã‚¯ãƒ«ã®éµå®ˆ
            å¿…ãšä»¥ä¸‹ã®é †åºã§å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ï¼š

            ### 1. Redï¼ˆå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼‰
            - Issueè¦ä»¶ã‚’æº€ãŸã™ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆ
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚‚å«ã‚ã¦ç¶²ç¾…çš„ã«ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
            - ã“ã®æ™‚ç‚¹ã§ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            - ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ `packages/${{ steps.extract-package.outputs.package }}/` é…ä¸‹ã«é…ç½®

            ### 2. Greenï¼ˆãƒ†ã‚¹ãƒˆã‚’é€šã™æœ€å°é™ã®å®Ÿè£…ï¼‰
            - ãƒ†ã‚¹ãƒˆã‚’é€šã™ãŸã‚ã®æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…
            - ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
            - å®Ÿè£…ã¯ `packages/${{ steps.extract-package.outputs.package }}/` å†…ã«é™å®š

            ### 3. Refactorï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
            - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Š
            - é‡è¤‡ã‚’æ’é™¤
            - CLAUDE.mdã®æŒ‡é‡ã«å¾“ã†
            - ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¸ã®å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª

            ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
            å®Ÿè£…æ™‚ã¯å¿…ãšä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ãã ã•ã„ï¼š
            - `ai-docs/security/codeguard-rules/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆ
            - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFå¯¾ç­–ã‚’å®Ÿè£…
            - æ©Ÿå¯†æƒ…å ±ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ç­‰ï¼‰ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
            - å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿…ãšå®Ÿè£…
            - å®‰å…¨ãªæš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ã¿ä½¿ç”¨

            ## å®Œäº†æ¡ä»¶
            - âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨
            - âœ… ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒé©åˆ‡ã§ã‚ã‚‹ã“ã¨
            - âœ… CLAUDE.mdã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã«æº–æ‹ ã—ã¦ã„ã‚‹ã“ã¨
            - âœ… CodeGuardã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹ã“ã¨
            - âœ… `packages/${{ steps.extract-package.outputs.package }}/` å†…ã®ã¿ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã“ã¨

            ## æˆæœç‰©
            å®Ÿè£…å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            1. **ãƒ–ãƒ©ãƒ³ãƒä½œæˆ**: `feature/${{ steps.extract-package.outputs.package }}/issue-${{ github.event.issue.number }}`
            2. **å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ**: "feat(${{ steps.extract-package.outputs.package }}): Issue #${{ github.event.issue.number }} ã‚’TDDã§å®Ÿè£…"
            3. **ãƒ‰ãƒ©ãƒ•ãƒˆPRä½œæˆ**:
               - ã‚¿ã‚¤ãƒˆãƒ«: "[${{ steps.extract-package.outputs.package }}] TDDå®Ÿè£…: ${{ github.event.issue.title }}"
               - æœ¬æ–‡ã«ä»¥ä¸‹ã‚’å«ã‚ã‚‹:
                 - ğŸ“¦ å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: `${{ steps.extract-package.outputs.package }}`
                 - ğŸ“ å®Ÿè£…å†…å®¹ã®æ¦‚è¦
                 - ğŸ”„ TDDã‚µã‚¤ã‚¯ãƒ«ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã£ãŸå†…å®¹
                 - ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®æƒ…å ±
                 - ğŸ“‚ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
                 - `Closes #${{ github.event.issue.number }}`
                 - `/cc @${{ github.event.issue.user.login }}`
