name: PRè‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç•ªå·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: number

permissions:
  contents: read
  pull-requests: write
  checks: write
  id-token: write

jobs:
  auto-test:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ¤åˆ¥
        id: detect-package
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒå: ${BRANCH_NAME}"

          # Issueç•ªå·ã‚’æŠ½å‡º (ä¾‹: feature/frontend/issue-1 -> 1)
          if [[ $BRANCH_NAME =~ issue-([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Issueç•ªå·: ${ISSUE_NUMBER}"

            # Issueã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            LABELS=$(gh issue view ${ISSUE_NUMBER} --json labels --jq '.labels[].name' | tr '\n' ',' || echo "")
            echo "Issueãƒ©ãƒ™ãƒ«: ${LABELS}"

            # tdd-implementãƒ©ãƒ™ãƒ«ã‹ã‚‰åˆ¤åˆ¥
            if [[ $LABELS == *"tdd-implement:frontend"* ]]; then
              PACKAGE="frontend"
            elif [[ $LABELS == *"tdd-implement:backend"* ]]; then
              PACKAGE="backend"
            else
              echo "âš ï¸ tdd-implementãƒ©ãƒ™ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              PACKAGE=""
            fi
          else
            echo "âš ï¸ Issueç•ªå·ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            PACKAGE=""
          fi

          echo "package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: ${PACKAGE}"
        env:
          GH_TOKEN: ${{ github.token }}

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„
      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (frontend)
        if: steps.detect-package.outputs.package == 'frontend'
        working-directory: packages/frontend
        run: npm install

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (frontend)
        if: steps.detect-package.outputs.package == 'frontend'
        working-directory: packages/frontend
        run: npm test

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (frontend)
        if: steps.detect-package.outputs.package == 'frontend'
        working-directory: packages/frontend
        run: npx playwright install --with-deps chromium firefox webkit

      - name: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (frontend)
        if: steps.detect-package.outputs.package == 'frontend'
        working-directory: packages/frontend
        run: npm run test:e2e

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (backend)
        if: steps.detect-package.outputs.package == 'backend'
        working-directory: packages/backend
        run: pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (backend)
        if: steps.detect-package.outputs.package == 'backend'
        working-directory: packages/backend
        run: pytest

  code-review:
    runs-on: ubuntu-latest
    needs: auto-test

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ¤åˆ¥
        id: detect-package
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒå: ${BRANCH_NAME}"

          # Issueç•ªå·ã‚’æŠ½å‡º (ä¾‹: feature/frontend/issue-1 -> 1)
          if [[ $BRANCH_NAME =~ issue-([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Issueç•ªå·: ${ISSUE_NUMBER}"

            # Issueã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            LABELS=$(gh issue view ${ISSUE_NUMBER} --json labels --jq '.labels[].name' | tr '\n' ',' || echo "")
            echo "Issueãƒ©ãƒ™ãƒ«: ${LABELS}"

            # tdd-implementãƒ©ãƒ™ãƒ«ã‹ã‚‰åˆ¤åˆ¥
            if [[ $LABELS == *"tdd-implement:frontend"* ]]; then
              PACKAGE="frontend"
            elif [[ $LABELS == *"tdd-implement:backend"* ]]; then
              PACKAGE="backend"
            else
              echo "âš ï¸ tdd-implementãƒ©ãƒ™ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              PACKAGE=""
            fi
          else
            echo "âš ï¸ Issueç•ªå·ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            PACKAGE=""
          fi

          echo "package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: ${PACKAGE}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Claude Codeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: steps.detect-package.outputs.package != ''
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--allowedTools Read,Glob,Grep,Bash"
          prompt: |
            ## ã‚¿ã‚¹ã‚¯
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (#${{ github.event.pull_request.number }}) ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

            ## ğŸ“¦ å¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            **${{ steps.detect-package.outputs.package }}** ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ `packages/${{ steps.detect-package.outputs.package }}/` é…ä¸‹ã®å¤‰æ›´ã‚’ä¸­å¿ƒã«è¡Œã£ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹

            ### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆCodeGuardãƒ«ãƒ¼ãƒ«æº–æ‹ ï¼‰
            `ai-docs/security/codeguard-rules/` ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFãªã©ã®è„†å¼±æ€§
            - æ©Ÿå¯†æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ç­‰ï¼‰
            - å®‰å…¨ã§ãªã„æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä½¿ç”¨
            - èªè¨¼ãƒ»èªå¯ã®ä¸å‚™
            - å…¥åŠ›æ¤œè¨¼ã®æ¬ å¦‚
            - ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ

            ### 2. ã‚³ãƒ¼ãƒ‰å“è³ª
            - CLAUDE.mdã®è¦ç´„æº–æ‹ 
            - å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œ
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

            ### 3. ãƒ†ã‚¹ãƒˆå“è³ª
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®é©åˆ‡æ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
            - ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§

            ### 4. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©åˆ‡ãªä½¿ç”¨
            - DRYåŸå‰‡ã®éµå®ˆ
            - SOLIDåŸå‰‡ã®éµå®ˆ

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®å½¢å¼

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ï¼š

            ```
            ## ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            ### âœ… è‰¯ã„ç‚¹
            - [è‰¯ã„ç‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—]

            ### âš ï¸ æ”¹å–„ææ¡ˆ
            - [æ”¹å–„ãŒå¿…è¦ãªç‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—]

            ### ğŸš¨ é‡å¤§ãªå•é¡Œ
            - [é‡å¤§ãªå•é¡ŒãŒã‚ã‚Œã°ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã€ãªã‘ã‚Œã°ã€Œãªã—ã€]

            ### ğŸ“Š ç·åˆè©•ä¾¡
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: [ğŸŸ¢å®‰å…¨ / ğŸŸ¡è¦ç¢ºèª / ğŸ”´å•é¡Œã‚ã‚Š]
            - ã‚³ãƒ¼ãƒ‰å“è³ª: [ğŸŸ¢è‰¯å¥½ / ğŸŸ¡æ”¹å–„æ¨å¥¨ / ğŸ”´è¦æ”¹å–„]
            - ãƒ†ã‚¹ãƒˆå“è³ª: [ğŸŸ¢ååˆ† / ğŸŸ¡è¿½åŠ æ¨å¥¨ / ğŸ”´ä¸ååˆ†]

            ### ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            [å•é¡Œãªã‘ã‚Œã°ã€Œãƒ‰ãƒ©ãƒ•ãƒˆè§£é™¤å¯èƒ½ã€ã€å•é¡ŒãŒã‚ã‚Œã°ã€Œä¿®æ­£ãŒå¿…è¦ã€ã¨å…·ä½“çš„ãªæŒ‡ç¤º]
            ```

            é‡å¤§ãªå•é¡ŒãŒãªã„å ´åˆã¯ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«è‡ªå‹•çš„ã«ãƒ‰ãƒ©ãƒ•ãƒˆã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚

  ready-for-review:
    runs-on: ubuntu-latest
    needs: code-review

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ‰ãƒ©ãƒ•ãƒˆè§£é™¤ã®æº–å‚™ç¢ºèª
        id: check-review
        run: |
          # Claude Codeã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ç¢ºèª
          # é‡å¤§ãªå•é¡ŒãŒãªã‘ã‚Œã°ãƒ‰ãƒ©ãƒ•ãƒˆè§£é™¤
          echo "review_status=approved" >> $GITHUB_OUTPUT

      - name: ãƒ‰ãƒ©ãƒ•ãƒˆè§£é™¤
        if: steps.check-review.outputs.review_status == 'approved'
        run: |
          gh pr ready ${{ github.event.pull_request.number }}
          gh pr comment ${{ github.event.pull_request.number }} --body "âœ… è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼

          - ğŸ§ª ãƒ†ã‚¹ãƒˆ: æˆåŠŸ
          - ğŸ‘€ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼: æ‰¿èª
          - ğŸ‰ ãƒ‰ãƒ©ãƒ•ãƒˆã‚’è§£é™¤ã—ã¾ã—ãŸ

          ã“ã®PRã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªçŠ¶æ…‹ã§ã™ã€‚æœ€çµ‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          /cc @${{ github.event.pull_request.user.login }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
